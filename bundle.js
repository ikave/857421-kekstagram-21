(()=>{"use strict";window.util={getRandomNum:(e,t)=>Math.round(e+Math.random()*(t-e)),getRandomValue:e=>e[Math.floor(Math.random()*e.length)],pressEscKey:(e,t)=>{"Escape"===e.key&&t()},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},(()=>{const e="https://21.javascript.pages.academy/kekstagram",t="https://21.javascript.pages.academy/kekstagram/data",o=(e,t)=>{let o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{let r;switch(o.status){case 200:e(o.response);break;case 400:r="Неверный запрос";break;case 401:r="Пользователь не авторизован";break;case 404:r="Ничего не найдено";break;default:r=`Cтатус ответа: ${o.status} ${o.statusText}`}r&&t(r)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout}мс`)})),o.timeout=1e4,o};window.server={load:(e,r)=>{const n=o(e,r);n.open("GET",t),n.send()},upload:(t,r,n)=>{const s=o(r,n);s.open("POST",e),s.send(t)}}})(),(()=>{const e=document.querySelector("body");let t=[];window.server.load((e=>{t=e.slice(),(e=>{for(let t=0;t<e.length;t++)e[t].id=t})(t),window.gallery.show(t),window.preview.data(t),window.filter(t)}),(t=>{const o=document.createElement("div");o.textContent=t,o.style.position="absolute",o.style.top=0,o.style.left=0,o.style.padding="50px",o.style.backgroundColor="red",e.append(o)}))})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelectorAll(".img-filters__button"),o=()=>{document.querySelectorAll(".picture").forEach((e=>{e.remove()}))};window.filter=r=>{e.classList.remove("img-filters--inactive");let n=r.slice();e.addEventListener("click",window.util.debounce((e=>{(e=>{t.forEach((t=>{t.classList.remove("img-filters__button--active"),e.target===t&&t.classList.add("img-filters__button--active")}))})(e);const s=e.target.id;"filter-default"===e.target.id?(o(),window.gallery.show(r)):"filter-random"===s?(o(),window.gallery.show((e=>e.slice().sort((()=>window.util.getRandomNum(-1,1))).slice(0,10))(n))):"filter-discussed"===s&&(o(),window.gallery.show((e=>e.sort(((e,t)=>t.comments.length-e.comments.length)))(n)))})))}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comments"),o=e.querySelector(".comments-shown"),r=e.querySelector(".comments-loader"),n=e.querySelector(".big-picture__cancel"),s=document.querySelector(".pictures");let l,i=0,c=5;const d=(e,t,o)=>{const r=document.createElement("li");r.classList.add("social__comment");const n=document.createElement("img");n.classList.add("social__picture"),n.setAttribute("src",e[t].avatar),n.setAttribute("alt",e[t].name),n.setAttribute("width","35"),n.setAttribute("height","35");const s=document.createElement("p");s.classList.add("social__text"),s.textContent=e[t].message,r.append(n),r.append(s),o.append(r)},a=e=>{const o=e.comments;o.length<=c&&(c=o.length,r.classList.add("hidden"));for(let e=i;e<c;e++)d(o,e,t);i+=5,c+=5},u=()=>{const e=t.children.length;o.textContent=e},m=()=>{a(l),u()},v=()=>{i=0,c=5,e.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),r.classList.remove("hidden"),p(),r.removeEventListener("click",m),window.removeEventListener("keydown",y)},y=e=>{window.util.pressEscKey(e,v)},p=()=>{t.querySelectorAll(".social__comment").forEach((e=>{e.remove()}))};n.addEventListener("click",(()=>{v(),n.removeEventListener("click",v)})),window.preview={data:e=>{s.addEventListener("click",(t=>{let o=t.target.closest(".picture");if(o)for(let t of e)t.id.toString()===o.dataset.id&&window.preview.show(t)}))},show:o=>{l=o,e.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),(()=>{const e=t.children,o=Array.from(e);for(let e of o)e.remove()})(),((e,t)=>{const o=e.querySelector(".big-picture__img").children,r=e.querySelector(".likes-count"),n=e.querySelector(".comments-count"),s=e.querySelector(".social__caption");o[0].setAttribute("src",t.url),s.textContent=t.description,r.textContent=t.likes,n.textContent=t.comments.length,a(l),u()})(e,o),r.addEventListener("click",m),window.addEventListener("keydown",y)}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture"),t=document.querySelector(".pictures"),o=t=>{const o=e.cloneNode(!0);return o.querySelector(".picture__img").setAttribute("src",t.url),o.querySelector(".picture__img").setAttribute("alt",t.description),o.querySelector(".picture__likes").textContent=t.likes,o.querySelector(".picture__comments").textContent=t.comments.length,o.setAttribute("data-id",t.id),o};window.gallery={show:e=>{const r=document.createDocumentFragment();for(let t=0;t<e.length;t++)r.appendChild(o(e[t]));t.appendChild(r)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("body"),o=document.querySelector("main"),r=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__overlay"),s=n.querySelector(".effect-level"),l=document.querySelectorAll(".effects__preview"),i=n.querySelector(".effect-level__line"),c=n.querySelector(".effect-level__pin"),d=n.querySelector(".effect-level__depth"),a=n.querySelectorAll(".effects__radio"),u=n.querySelector(".effect-level__value"),m=document.querySelector(".img-upload__form"),v=m.querySelector(".img-upload__scale"),y=m.querySelector(".img-upload__preview img"),p=m.querySelector(".text__hashtags"),w=m.querySelector(".text__description"),f=m.querySelector(".scale__control--value"),h=document.querySelector("#success").content.querySelector(".success"),g=document.querySelector("#error").content.querySelector(".error");let L=100;const _=()=>{let e=(L=u.value,{none:"none",chrome:`grayscale(${L/100})`,sepia:`sepia(${L/100})`,marvin:`invert(${L}%)`,phobos:`blur(${3*L/100}px)`,heat:`brightness(${3*L/100})`});a.forEach((t=>{if(t.checked)for(let o in e)t.value===o?y.style.filter=e[o]:"none"===t.value?s.style.visibility="hidden":s.style.visibility="visible"}))},E=()=>{A();const e=h.cloneNode(!0);o.append(e),e.addEventListener("click",q)},S=()=>{A();const e=g.cloneNode(!0);o.append(e),e.addEventListener("click",q)},q=e=>{const t=e.target;"button"!==t.type&&"section"!==t.tagName.toLowerCase()||x()},b=e=>{window.util.pressEscKey(e,x)},k=e=>{e.preventDefault(),(()=>{t.classList.add("modal-open"),window.addEventListener("keydown",b);const e=new FormData(m);window.server.upload(e,E,S)})()},x=()=>{let e;const o=document.querySelector(".success"),r=document.querySelector(".error");e=o||r,e.remove(),t.classList.remove("modal-open"),e.removeEventListener("click",q),window.removeEventListener("keydown",b)},C=e=>{e.preventDefault();let t={x:e.clientX};const o=e=>{let o=t.x-e.clientX;t.x=e.clientX;let r=c.offsetLeft-o;r>i.offsetWidth?(r=i.offsetWidth,d.style.width=i.offsetWidth):r<=0?(r=0,d.style.width=0):(d.style.width=r+"px",c.style.left=r+"px"),u.setAttribute("value",Math.round(c.offsetLeft/i.offsetWidth*100)),L=u.value,_()},r=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)},A=()=>{n.classList.add("hidden"),v.removeEventListener("click",$),r.value="";for(let e=0;e<a.length;e++)a[e].checked&&(a[e].checked=!1);a[0].checked=!0,c.removeEventListener("mousedown",C),m.removeEventListener("submit",k),window.removeEventListener("keydown",V),w.value=""},$=e=>{((e,t)=>{let o=parseInt(t.value,10);e.target.classList.contains("scale__control--smaller")&&(o-=25,t.value=o+"%",o<=25&&(o=25,t.value=o+"%"),y.style.transform=`scale(${o/100})`),e.target.classList.contains("scale__control--bigger")&&(o+=25,t.value=o+"%",o>100&&(o=100,t.value=o+"%"),y.style.transform=`scale(${o/100})`)})(e,f)},V=e=>{t.classList.remove("modal-open"),window.util.pressEscKey(e,A)};r.addEventListener("change",(()=>{(()=>{const t=r.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{y.setAttribute("src",e.result),l.forEach((t=>{t.style.backgroundImage=`url(${e.result})`}))})),e.readAsDataURL(t)}})(),n.classList.remove("hidden"),t.classList.add("modal-open"),p.value="",f.value="100%",y.style.transform="scale(1)",m.addEventListener("submit",k),_(),v.addEventListener("click",$),window.addEventListener("keydown",V),L=u.value,m.addEventListener("change",(e=>{"radio"===e.target.type&&(L=100,u.setAttribute("value",L),c.style.left=i.offsetWidth+"px",d.style.width=i.offsetWidth+"px",_())})),c.addEventListener("mousedown",C),p.addEventListener("focus",(()=>{window.removeEventListener("keydown",V)})),p.addEventListener("blur",(()=>{window.addEventListener("keydown",V)})),w.addEventListener("focus",(()=>{window.removeEventListener("keydown",V)})),w.addEventListener("blur",(()=>{window.addEventListener("keydown",V)})),window.form={close:A}}))})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".text__hashtags"),o=e.querySelector(".text__description"),r=document.querySelector(".img-upload__overlay").querySelector("#upload-cancel"),n=e=>/^#[0-9a-zA-Zа-яА-ЯёЁ]*$/.test(e);t.addEventListener("input",(()=>{(()=>{let e=(e=>{let t=[],o=e.toLowerCase().split(" ");for(let e of o)""!==e&&t.push(e);return t})(t.value);(e=>{let t=!0;for(let o of e){if(!n(o))return t=!1,t;t=!0}return t})(e)?e.length>5?t.setCustomValidity("Максимальная количество хеш-тегов не может быть больше 5"):(e=>{let t=!1;for(let o of e){if(o.length>20)return t=!0,t;t=!1}return t})(e)?t.setCustomValidity("Максимальная длинна хештега 20 символов"):(e=>{let t=!1;for(let o of e){if("#"===o)return t=!0,t;t=!1}return t})(e)?t.setCustomValidity("Хеш-тег не может состоять только из одной решётки"):(e=>{let t=[],o=!1;if(e.length>1)for(let r of e){if(-1!==t.indexOf(r))return o=!0,o;t.push(r),o=!1}return o})(e)?t.setCustomValidity("Этот хеш-тег уже используется"):t.setCustomValidity(""):t.setCustomValidity("Неверный хеш-тег")})()})),o.addEventListener("input",(()=>{o.value.length>140?o.setCustomValidity("Максимальная длинна сообщения 140 символов"):o.setCustomValidity("")})),r.addEventListener("click",(()=>{document.querySelector("body").classList.remove("modal-open"),window.form.close()}))})()})();